# Phase 2: コア機能実装 - 実装計画

## Phase 2 概要
映像取得・表示・保存機能、およびスナップショット・基本イベント検知機能を実装

## 実装順序と優先度

### 1. RTSPストリーム映像取得実装 (高優先度)
**目標**: リアルタイム映像ストリーミングの確立

**技術詳細:**
- RTSP URL: `rtsp://admin:[password]@192.168.31.85:554/h264Preview_01_main`
- OpenCVを使用したRTSPストリーム取得
- フレームバッファリング制御
- 接続エラー・切断時の自動復旧

**実装内容:**
- `rtsp_stream.py` - RTSP基本接続クラス
- ストリーム品質設定（解像度・フレームレート調整）
- 接続状態監視機能

### 2. OpenCV映像表示・保存機能 (高優先度)  
**目標**: 取得した映像の表示・録画機能

**技術詳細:**
- リアルタイム映像表示（cv2.imshow）
- 映像ファイル保存（MP4, AVI形式）
- フレームドロップ対策
- CPUリソース管理

**実装内容:**
- `video_viewer.py` - 映像表示アプリケーション
- `video_recorder.py` - 映像録画機能
- キーボード操作インターフェース（録画開始/停止等）

### 3. スナップショット機能 (中優先度)
**目標**: 静止画取得・保存機能

**技術詳細:**
- reolinkapi経由でのスナップショット取得
- 高解像度静止画保存
- タイムスタンプ付きファイル名
- 連続撮影機能

**実装内容:**
- `snapshot.py` - スナップショット機能
- 自動保存機能（指定間隔での撮影）
- 画像品質設定

### 4. 基本イベント検知実装 (中優先度)
**目標**: モーション検知・イベント取得機能

**技術詳細:**
- reolinkapi経由でのイベント取得
- モーション検知状態監視
- イベントログ記録
- リアルタイム通知機能

**実装内容:**
- `event_monitor.py` - イベント監視システム
- イベント履歴管理
- 検知エリア設定機能

## 技術仕様

### RTSP設定
```
プライマリストリーム: rtsp://admin:[password]@192.168.31.85:554/h264Preview_01_main
サブストリーム: rtsp://admin:[password]@192.168.31.85:554/h264Preview_01_sub
```

### 映像設定
- **解像度**: 2560×1920 (メイン), 640×480 (サブ)
- **フレームレート**: 15-30 fps
- **コーデック**: H.264
- **ビットレート**: 可変（ネットワーク状況に応じて調整）

### ファイル出力
- **映像**: MP4形式（H.264エンコード）
- **静止画**: JPEG形式（高画質設定）
- **ログ**: JSON形式

## 実装ファイル構成

```
/home/mushipi/Scripts/hamcam_reolink/
├── rtsp_stream.py          # RTSPストリーム基本クラス
├── video_viewer.py         # 映像表示アプリケーション
├── video_recorder.py       # 映像録画機能
├── snapshot.py            # スナップショット機能
├── event_monitor.py       # イベント監視システム
├── utils/
│   ├── camera_config.py   # カメラ設定管理
│   └── logger.py          # ログ機能
└── examples/
    ├── live_view_demo.py   # ライブ表示デモ
    ├── recording_demo.py   # 録画デモ
    └── snapshot_demo.py    # スナップショットデモ
```

## エラーハンドリング戦略

### 接続エラー対策
- 自動再接続機能（指数バックオフ）
- タイムアウト設定
- ネットワーク状態監視

### リソース管理
- メモリ使用量監視
- フレームバッファサイズ制限
- CPU使用率制御

### ログ・デバッグ
- 詳細ログ出力
- パフォーマンス測定
- エラー統計収集

## テスト計画

### 機能テスト
1. **RTSP接続テスト**
   - 各ストリーム品質での接続確認
   - 長時間接続安定性テスト

2. **映像品質テスト**
   - フレームレート測定
   - 映像品質評価
   - 遅延測定

3. **ファイル出力テスト**
   - 映像ファイル再生確認
   - ファイルサイズ・品質検証

### 負荷テスト
- 長時間録画テスト（24時間）
- 複数ストリーム同時処理
- メモリリーク検証

## パフォーマンス目標

### 映像ストリーミング
- **フレームレート**: 15fps以上維持
- **遅延**: 1秒以下
- **フレームドロップ**: 5%以下

### リソース使用量
- **CPU使用率**: 50%以下
- **メモリ使用量**: 500MB以下
- **ネットワーク帯域**: 10Mbps以下

## Phase 2 完了条件

### 必須機能
- ✅ RTSPストリーム安定取得
- ✅ リアルタイム映像表示
- ✅ 映像ファイル保存
- ✅ スナップショット取得

### 推奨機能
- ✅ 基本イベント検知
- ✅ エラー自動復旧
- ✅ 設定ファイル対応
- ✅ ログ機能

## 次フェーズ予告 (Phase 3)
- AI検知イベント高度処理
- リアルタイム通知システム
- 映像解析機能連携
- Web UI実装

**Phase 2 開始日**: 2025年7月20日
**Phase 2 目標完了日**: TBD